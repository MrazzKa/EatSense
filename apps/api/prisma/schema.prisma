generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER EXPERTS ROLE ====================

enum UserExpertsRole {
  USER
  EXPERT
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  password               String?
  appleUserId            String?                 @unique
  profile                Json?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  aiAssistant            AiAssistant[]
  analyses               Analysis[]
  labResults             LabResult[]
  magicLinks             MagicLink[]
  mealLogs               MealLog[]
  meals                  Meal[]
  media                  Media[]
  notificationPreference NotificationPreference?
  otps                   Otp[]
  pushTokens             PushToken[]
  refreshTokens          RefreshToken[]
  userProfile            UserProfile?
  userStats              UserStats?
  medications            MedicationSchedule[]
  medicationsNew         Medication[]            @relation("UserMedications")
  analysisCorrections    AnalysisCorrection[]

  // Experts Marketplace
  expertsRole            UserExpertsRole   @default(USER) @map("experts_role")
  expertProfile          ExpertProfile?
  clientConversations    Conversation[]    @relation("ClientConversations")
  sentMessages           Message[]
  clientReviews          Review[]          @relation("ClientReviews")
  disclaimerAcceptances  DisclaimerAcceptance[]
  abuseReports           AbuseReport[]
  blocksMade             UserBlock[]       @relation("BlocksMade")
  blocksReceived         UserBlock[]       @relation("BlocksReceived")

  // Diet Programs
  userDietPrograms    UserDietProgram[]
  dietRatings         DietProgramRating[] @relation("UserDietRatings")

  // Referral System
  referralCode        ReferralCode?  @relation("UserReferralCode")
  referralsMade       Referral[]     @relation("ReferrerUser")
  referredBy          Referral?      @relation("ReferredUser")

  @@map("users")
}

model UserProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  firstName             String?
  lastName              String?
  age                   Int?
  height                Float?
  weight                Float?
  gender                String?
  activityLevel         String?
  goal                  String?
  targetWeight          Float?
  dailyCalories         Int?
  avatarUrl             String?
  preferences           Json?
  healthProfile         Json?
  isOnboardingCompleted Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Analysis {
  id        String           @id @default(cuid())
  userId    String
  type      String
  status    String
  metadata  Json?
  error     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  results   AnalysisResult[]

  @@map("analyses")
}

model AnalysisResult {
  id         String   @id @default(cuid())
  analysisId String
  data       Json
  createdAt  DateTime @default(now())
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@map("analysis_results")
}

model Meal {
  id             String     @id @default(cuid())
  userId         String
  name           String
  type           String
  consumedAt     DateTime?
  healthScore    Float?     @map("health_score")
  healthGrade    String?    @map("health_grade")
  healthInsights Json?      @map("health_insights")
  imageUri       String?    @map("image_uri")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  items          MealItem[]
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("meals")
}

model MealItem {
  id       String  @id @default(cuid())
  mealId   String
  name     String
  calories Float
  protein  Float
  fat      Float
  carbs    Float
  weight   Float?
  fiber    Float?
  sugars   Float?
  satFat   Float?  @map("sat_fat")
  meal     Meal    @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@map("meal_items")
}

model MealLog {
  id        String          @id @default(cuid())
  userId    String
  mealType  MealLogMealType
  fdcId     String?
  label     String
  quantity  Float?
  unit      String?
  calories  Float?
  protein   Float?
  fat       Float?
  carbs     Float?
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([fdcId])
  @@map("meal_logs")
}

model Media {
  id              String   @id @default(cuid())
  userId          String
  filename        String
  mimetype        String
  size            Int
  data            Bytes?
  storageKey      String?
  storageBucket   String?
  storageProvider String?  @default("database")
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("media")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  jti       String?  @unique
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Otp {
  id        String   @id @default(cuid())
  userId    String
  code      String
  secret    String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otps")
}

model MagicLink {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@map("magic_links")
}

model AiAssistant {
  id               String   @id @default(cuid())
  userId           String
  type             String
  question         String
  answer           String
  context          Json?
  tokensUsed       Int?
  promptTokens     Int?
  completionTokens Int?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_assistant")
}

model PushToken {
  id         String    @id @default(cuid())
  userId     String?
  token      String    @unique
  deviceId   String?
  platform   String?
  appVersion String?
  enabled    Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_tokens")
}

model NotificationPreference {
  id               String    @id @default(cuid())
  userId           String    @unique
  dailyPushEnabled Boolean   @default(false)
  dailyPushHour    Int       @default(8)
  dailyPushMinute  Int       @default(0)
  timezone         String    @default("UTC")
  lastPushSentAt   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Article {
  id             String    @id @default(cuid())
  slug           String
  title          String
  contentHtml    String?   @map("content_html")
  excerpt        String?   @map("excerpt")
  coverUrl       String?   @map("cover_url")
  coverAlt       String?   @map("cover_alt")
  sourceName     String?   @map("source_name")
  sourceUrl      String?   @map("source_url")
  readingMinutes Int?      @map("reading_minutes")
  tags           String[]
  isFeatured     Boolean   @default(false) @map("is_featured")
  isPublished    Boolean   @default(true) @map("is_published")
  viewCount      Int       @default(0) @map("view_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  publishedAt    DateTime? @map("published_at")
  authorId       String?   @map("author_id")
  bodyMarkdown   String    @map("body_markdown")
  heroImageUrl   String?   @map("hero_image_url")
  isActive       Boolean   @default(true) @map("is_active")
  locale         String    @default("ru")
  subtitle       String?   @map("subtitle")
  
  // Expert author (optional - for expert-written articles)
  expertId       String?   @map("expert_id")
  expert         ExpertProfile? @relation(fields: [expertId], references: [id], onDelete: SetNull)

  @@unique([slug, locale])
  @@index([locale, isActive])
  @@index([isActive, isFeatured])
  @@index([tags])
  @@index([expertId])
  @@map("articles")
}

model Food {
  id             String                   @id @default(uuid())
  fdcId          Int                      @unique @map("fdc_id")
  dataType       String                   @map("data_type")
  description    String
  brandOwner     String?                  @map("brand_owner")
  gtinUpc        String?                  @unique @map("gtin_upc")
  scientificName String?                  @map("scientific_name")
  publishedAt    DateTime?                @map("published_at")
  updatedAt      DateTime?                @map("updated_at")
  source         FoodSource               @default(USDA_LOCAL)
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAtRow   DateTime                 @updatedAt @map("updated_at_row")
  searchVector   Unsupported("tsvector")? @map("search_vector")
  embedding      FoodEmbedding?
  nutrients      FoodNutrient[]
  portions       FoodPortion[]
  label          LabelNutrients?

  @@index([fdcId])
  @@index([dataType])
  @@index([description])
  @@map("foods")
}

model FoodPortion {
  id          String  @id @default(uuid())
  foodId      String  @map("food_id")
  gramWeight  Float   @map("gram_weight")
  measureUnit String  @map("measure_unit")
  modifier    String?
  amount      Float?
  food        Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_portions")
}

model Nutrient {
  id       Int            @id
  number   String?
  name     String
  unitName String         @map("unit_name")
  rank     Int?
  foods    FoodNutrient[]

  @@map("nutrients")
}

model FoodNutrient {
  id         String   @id @default(uuid())
  foodId     String   @map("food_id")
  nutrientId Int      @map("nutrient_id")
  amount     Float
  food       Food     @relation(fields: [foodId], references: [id], onDelete: Cascade)
  nutrient   Nutrient @relation(fields: [nutrientId], references: [id])

  @@unique([foodId, nutrientId])
  @@index([foodId])
  @@index([nutrientId])
  @@map("food_nutrients")
}

model LabelNutrients {
  foodId        String @id @map("food_id")
  calories      Float?
  protein       Float?
  fat           Float?
  carbohydrates Float?
  fiber         Float?
  sugars        Float?
  sodium        Float?
  cholesterol   Float?
  potassium     Float?
  calcium       Float?
  iron          Float?
  food          Food   @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@map("label_nutrients")
}

model FoodEmbedding {
  foodId    String  @id @map("food_id")
  embedding Bytes
  doc       String
  ts        String?
  food      Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_embeddings")
}

enum MealLogMealType {
  BREAKFAST
  LUNCH
  DINNER
}

model UserStats {
  id                  String    @id @default(cuid())
  userId              String    @unique
  totalPhotosAnalyzed Int       @default(0) @map("total_photos_analyzed")
  todayPhotosAnalyzed Int       @default(0) @map("today_photos_analyzed")
  lastAnalysisDate    DateTime? @map("last_analysis_date")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}

model AnalysisCorrection {
  id              String    @id @default(cuid())
  userId          String
  analysisId      String?
  mealId          String?
  itemId          String?
  originalName    String
  correctedName   String?
  originalPortionG Float?   @map("original_portion_g")
  correctedPortionG Float?  @map("corrected_portion_g")
  originalCalories Float?   @map("original_calories")
  correctedCalories Float?  @map("corrected_calories")
  originalProtein Float?   @map("original_protein")
  correctedProtein Float?  @map("corrected_protein")
  originalCarbs   Float?   @map("original_carbs")
  correctedCarbs  Float?   @map("corrected_carbs")
  originalFat     Float?   @map("original_fat")
  correctedFat    Float?   @map("corrected_fat")
  correctionType  String   @map("correction_type")
  foodCategory    String?  @map("food_category")
  createdAt       DateTime @default(now()) @map("created_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([analysisId])
  @@index([mealId])
  @@index([correctionType])
  @@index([foodCategory])
  @@map("analysis_corrections")
}

// P3.1: Medication Schedule Model (legacy - kept for backward compatibility)
model MedicationSchedule {
  id              String    @id @default(cuid())
  userId          String
  name            String
  dosage          String? // e.g., "1 tablet", "500mg"
  frequency       String // e.g., "daily", "twice_daily", "weekly", "custom"
  times           String[] // Array of time strings in HH:mm format, e.g., ["08:00", "20:00"]
  daysOfWeek      Int[] // 0-6 (Sunday-Saturday), empty array means every day
  startDate       DateTime  @default(now()) @map("start_date")
  endDate         DateTime? @map("end_date")
  notes           String?
  isActive        Boolean   @default(true) @map("is_active")
  reminderEnabled Boolean   @default(true) @map("reminder_enabled")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("medication_schedules")
}

// P3.1: New Medication Model with MedicationDose support
model Medication {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation("UserMedications", fields: [userId], references: [id], onDelete: Cascade)
  name         String // Название лекарства: "Метформин", "Витамин D" и т.п.
  dosage       String? // Свободная строка: "500 mg", "1 таблетка", ...
  instructions String? // Доп. инструкции: "Перед едой", "После ужина" и т.д.
  startDate    DateTime  @default(now()) // Дата начала курса
  endDate      DateTime? // Дата окончания курса (nullable; если null — бессрочно)
  timezone     String    @default("UTC") // IANA timezone, например "Asia/Almaty"
  isActive     Boolean   @default(true)
  
  // P3.2: Medication quantity and stock tracking
  quantity     Int?      // Общее количество таблеток в упаковке (nullable - опционально)
  remainingStock Int?    // Остаток таблеток (nullable - опционально, вычисляется автоматически)
  lowStockThreshold Int? @default(7) // Порог для уведомления о низком остатке (дни до окончания)
  lastStockUpdate DateTime? // Дата последнего обновления остатка
  imageUrl     String?   // Фото лекарства

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doses MedicationDose[]

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("medications")
}

model MedicationDose {
  id           String     @id @default(cuid())
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  // Время приёма в формате "HH:mm" (локальное время в timezone лекарства)
  timeOfDay String

  beforeMeal Boolean @default(false)
  afterMeal  Boolean @default(false)
  
  // Количество таблеток на один приём
  pillsPerDose Int @default(1) @map("pills_per_dose")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("medication_doses")
}

model LabResult {
  id             String      @id @default(cuid())
  userId         String
  rawText        String?     @map("raw_text")
  summary        String?
  recommendation String?
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics        LabMetric[]

  @@index([userId, createdAt])
  @@map("lab_results")
}

model LabMetric {
  id          String    @id @default(cuid())
  labResultId String    @map("lab_result_id")
  name        String
  value       Float
  unit        String
  isNormal    Boolean   @default(true) @map("is_normal")
  level       String // "low", "normal", "high"
  comment     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  labResult   LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@map("lab_metrics")
}

enum FoodSource {
  USDA_LOCAL
  USDA_API
}

// Локальная таблица топ-100 самых частых продуктов для быстрого поиска
model LocalFood {
  id          String   @id @default(cuid())
  name        String   // Название продукта (нормализованное)
  nameEn      String?  @map("name_en") // Английское название
  nameRu      String?  @map("name_ru") // Русское название
  nameKk      String?  @map("name_kk") // Казахское название
  
  // Питательные вещества на 100г
  calories    Float    @default(0)
  protein     Float    @default(0)
  carbs       Float    @default(0)
  fat         Float    @default(0)
  fiber       Float?   @default(0)
  sugars      Float?   @default(0)
  satFat      Float?   @default(0) @map("sat_fat")
  
  // Категория
  category    String?  // "vegetable", "fruit", "meat", "dairy", etc.
  
  // Порядок сортировки (чем меньше, тем популярнее)
  popularity  Int      @default(100)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([name])
  @@index([name])
  @@index([popularity])
  @@index([category])
  @@map("local_foods")
}

// ==================== EXPERTS MARKETPLACE ====================

enum OfferFormat {
  CHAT_CONSULTATION
  MEAL_PLAN
  REPORT_REVIEW
  MONTHLY_SUPPORT
  CUSTOM
}

enum PriceType {
  FREE
  FIXED
  FROM
  CONTACT
}

model ExpertProfile {
  id                String   @id @default(cuid())
  userId            String   @unique @map("user_id")
  type              String   // "dietitian" | "nutritionist"
  displayName       String   @map("display_name")
  title             String?  // "Certified Dietitian, PhD"
  bio               String?
  avatarUrl         String?  @map("avatar_url")
  
  // Education & Credentials
  education         String?
  experienceYears   Int      @default(0) @map("experience_years")
  specializations   String[] @default([])
  languages         String[] @default(["en"])
  
  // Verification
  isVerified        Boolean  @default(false) @map("is_verified")
  verifiedAt        DateTime? @map("verified_at")
  
  // Settings
  isActive          Boolean  @default(true) @map("is_active")
  isPublished       Boolean  @default(false) @map("is_published")
  contactPolicy     String?  @map("contact_policy")
  
  // Stats (aggregated)
  rating            Float    @default(0)
  reviewCount       Int      @default(0) @map("review_count")
  consultationCount Int      @default(0) @map("consultation_count")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentials       ExpertCredential[]
  offers            ExpertOffer[]
  conversations     Conversation[]
  reviews           Review[]
  articles          Article[]
  
  @@index([type, isActive, isPublished])
  @@index([isVerified, isActive])
  @@index([rating])
  @@map("expert_profiles")
}

model ExpertCredential {
  id          String    @id @default(cuid())
  expertId    String    @map("expert_id")
  name        String    // "Medical License", "Nutrition Certificate"
  issuer      String?   // "State Medical Board"
  issuedAt    DateTime? @map("issued_at")
  expiresAt   DateTime? @map("expires_at")
  fileUrl     String?   @map("file_url")
  fileType    String?   @map("file_type") // "pdf" | "image"
  status      String    @default("pending") // "pending" | "approved" | "rejected"
  createdAt   DateTime  @default(now()) @map("created_at")
  
  expert      ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  
  @@index([expertId])
  @@map("expert_credentials")
}

model ExpertOffer {
  id            String      @id @default(cuid())
  expertId      String      @map("expert_id")
  name          Json        // { en: "...", ru: "...", kk: "..." }
  description   Json?       // Localized
  format        OfferFormat @default(CHAT_CONSULTATION)
  
  // Pricing (MVP: only FREE enabled in UI)
  priceType     PriceType   @default(FREE) @map("price_type")
  priceAmount   Float?      @map("price_amount")
  currency      String      @default("USD")
  
  // Details
  durationDays  Int?        @map("duration_days")
  deliverables  Json?       // Localized list of what's included
  
  // Status
  isPublished   Boolean     @default(false) @map("is_published")
  sortOrder     Int         @default(0) @map("sort_order")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  expert        ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  
  @@index([expertId, isPublished])
  @@map("expert_offers")
}

model Conversation {
  id              String   @id @default(cuid())
  clientId        String   @map("client_id")
  expertId        String   @map("expert_id")
  offerId         String?  @map("offer_id")
  
  status          String   @default("active") // "active" | "completed" | "cancelled"
  
  // Report sharing consent
  reportsShared   Boolean  @default(false) @map("reports_shared")
  
  // Timestamps
  startedAt       DateTime @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")
  lastMessageAt   DateTime? @map("last_message_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  client          User          @relation("ClientConversations", fields: [clientId], references: [id], onDelete: Cascade)
  expert          ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  offer           ExpertOffer?  @relation(fields: [offerId], references: [id], onDelete: SetNull)
  messages        Message[]
  review          Review?
  
  @@unique([clientId, expertId])
  @@index([clientId, status])
  @@index([expertId, status])
  @@map("conversations")
}

model Message {
  id              String   @id @default(cuid())
  conversationId  String   @map("conversation_id")
  senderId        String   @map("sender_id")
  
  type            String   @default("text") // "text" | "image" | "file" | "report_share"
  content         String
  metadata        Json?    // For attachments: { fileName, fileSize, mimeType, url }
  
  isRead          Boolean  @default(false) @map("is_read")
  createdAt       DateTime @default(now()) @map("created_at")
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model Review {
  id              String   @id @default(cuid())
  conversationId  String?  @unique @map("conversation_id")
  clientId        String   @map("client_id")
  expertId        String   @map("expert_id")
  
  rating          Int      // 1-5
  comment         String?
  
  isVisible       Boolean  @default(true) @map("is_visible")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  conversation    Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  client          User          @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)
  expert          ExpertProfile @relation(fields: [expertId], references: [id], onDelete: Cascade)
  
  @@unique([clientId, expertId])
  @@index([expertId, isVisible])
  @@map("reviews")
}

model DisclaimerAcceptance {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String   // "experts_chat"
  acceptedAt  DateTime @default(now()) @map("accepted_at")
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, type])
  @@map("disclaimer_acceptances")
}

model AbuseReport {
  id               String   @id @default(cuid())
  reporterId       String   @map("reporter_id")
  reportedUserId   String?  @map("reported_user_id")
  reportedExpertId String?  @map("reported_expert_id")
  conversationId   String?  @map("conversation_id")
  
  category         String   // "spam" | "harassment" | "inappropriate" | "fraud" | "other"
  description      String?
  attachmentUrls   String[] @default([]) @map("attachment_urls")
  
  status           String   @default("pending") // "pending" | "reviewed" | "resolved"
  createdAt        DateTime @default(now()) @map("created_at")
  
  reporter         User @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@map("abuse_reports")
}

model UserBlock {
  id          String   @id @default(cuid())
  blockerId   String   @map("blocker_id")
  blockedId   String   @map("blocked_id")
  createdAt   DateTime @default(now()) @map("created_at")
  
  blocker     User @relation("BlocksMade", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked     User @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)
  
  @@unique([blockerId, blockedId])
  @@map("user_blocks")
}

// ==================== DIET PROGRAMS ====================

enum DietType {
  WEIGHT_LOSS
  WEIGHT_GAIN
  HEALTH
  MEDICAL
  LIFESTYLE
  SPORTS
}

enum DietDifficulty {
  EASY
  MODERATE
  HARD
}

model DietProgram {
  id              String          @id @default(cuid())
  slug            String          @unique
  name            Json            // { en: "...", ru: "...", kk: "..." }
  subtitle        Json?           // Localized subtitle
  description     Json?           // Localized description
  shortDescription Json?          @map("short_description") // For cards
  imageUrl        String?         @map("image_url")
  iconUrl         String?         @map("icon_url")
  color           String?         // UI color like #4CAF50
  
  // Type and difficulty
  category        String          // "hollywood" | "athletes" | "historical" | "modern" | "medical" | "cultural"
  type            DietType        @default(HEALTH)
  difficulty      DietDifficulty  @default(MODERATE)
  duration        Int             // Days
  
  // UI grouping and evidence
  uiGroup         String?         @map("ui_group") // "Popular" | "Health" | "Weight loss" | "Performance" | "Medical" | "Historical"
  evidenceLevel   String?         @map("evidence_level") // "high" | "medium" | "low"
  disclaimerKey   String?         @map("disclaimer_key") // "DISCLAIMER_GENERAL" | "DISCLAIMER_MEDICAL" | "DISCLAIMER_HISTORICAL"
  
  // Nutrition targets
  dailyCalories   Int?            @map("daily_calories")
  dailyCaloriesMin Int?           @map("daily_calories_min")
  dailyCaloriesMax Int?           @map("daily_calories_max")
  macroSplit      Json?           @map("macro_split") // { protein: 30, carbs: 40, fat: 30 }
  
  // Suitability
  suitableFor     String[]        @default([]) // ['weight_loss', 'diabetes', 'athletes']
  notSuitableFor  String[]        @default([]) @map("not_suitable_for") // ['pregnant', 'kidney_disease']
  
  // Food restrictions
  allowedFoods    String[]        @default([]) @map("allowed_foods")
  restrictedFoods String[]        @default([]) @map("restricted_foods")
  
  // Tips, rules, and tracker
  tips            Json?           // { en: [...], ru: [...] }
  rules           Json?           // Special rules
  howItWorks      Json?           @map("how_it_works") // { en: [...], ru: [...], kk: [...] } - bullets
  dailyTracker    Json?           @map("daily_tracker") // [{ key: "veggies_5", label: { en: "...", ru: "...", kk: "..." } }, ...]
  weeklyGoals     Json?           @map("weekly_goals") // Optional weekly goals
  notFor          Json?           @map("not_for") // Contraindications { en: [...], ru: [...], kk: [...] }
  sampleDay       Json?           @map("sample_day") // { en: "...", ru: "...", kk: "..." } - Example one-day menu
  
  // Streak settings
  streakThreshold Float           @default(0.7) @map("streak_threshold") // Per-diet threshold (0.0-1.0)
  
  // Stats
  tags            String[]
  popularityScore Int             @default(0) @map("popularity_score")
  userCount       Int             @default(0) @map("user_count")
  averageRating   Float           @default(0) @map("average_rating")
  ratingCount     Int             @default(0) @map("rating_count")
  
  // Status
  isActive        Boolean         @default(true) @map("is_active")
  isFeatured      Boolean         @default(false) @map("is_featured")
  sortOrder       Int             @default(0) @map("sort_order")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  days            DietProgramDay[]
  userPrograms    UserDietProgram[]
  ratings         DietProgramRating[]

  @@index([category, isActive])
  @@index([type, isActive])
  @@index([isFeatured, isActive])
  @@index([popularityScore])
  @@index([uiGroup, isActive])
  @@map("diet_programs")
}

model DietProgramDay {
  id              String   @id @default(cuid())
  programId       String   @map("program_id")
  dayNumber       Int      @map("day_number")
  title           String?
  description     String?
  totalCalories   Int?     @map("total_calories")
  totalProtein    Float?   @map("total_protein")
  totalCarbs      Float?   @map("total_carbs")
  totalFat        Float?   @map("total_fat")

  program         DietProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  meals           DietProgramMeal[]

  @@unique([programId, dayNumber])
  @@index([programId])
  @@map("diet_program_days")
}

model DietProgramMeal {
  id              String   @id @default(cuid())
  dayId           String   @map("day_id")
  mealType        String   @map("meal_type") // "breakfast" | "lunch" | "dinner" | "snack"
  name            String
  description     String?
  calories        Int?
  protein         Float?
  carbs           Float?
  fat             Float?
  sortOrder       Int      @default(0) @map("sort_order")

  day             DietProgramDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@index([dayId])
  @@map("diet_program_meals")
}

model UserDietProgram {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  programId       String    @map("program_id")
  startedAt       DateTime  @default(now()) @map("started_at")
  currentDay      Int       @default(1) @map("current_day")
  status          String    @default("active") // "active" | "completed" | "paused" | "abandoned"
  completedAt     DateTime? @map("completed_at")
  
  // Customization
  customCalories  Int?      @map("custom_calories")
  targetWeight    Float?    @map("target_weight")
  startWeight     Float?    @map("start_weight")
  currentWeight   Float?    @map("current_weight")
  
  // Stats
  daysCompleted   Int       @default(0) @map("days_completed")
  mealsLogged     Int       @default(0) @map("meals_logged")
  adherenceScore  Float     @default(0) @map("adherence_score")
  
  // Streak tracking
  currentStreak   Int       @default(0) @map("current_streak") // Current consecutive days meeting threshold
  longestStreak   Int       @default(0) @map("longest_streak") // Best streak ever
  lastStreakDate  DateTime? @map("last_streak_date") // Last date streak was updated

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  program         DietProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  dailyLogs       UserDietDailyLog[]

  @@unique([userId, programId])
  @@index([userId, status])
  @@map("user_diet_programs")
}

// Daily log for diet adherence tracking
model UserDietDailyLog {
  id              String      @id @default(cuid())
  userDietId      String      @map("user_diet_id")
  date            DateTime    @db.Date
  dayNumber       Int         @map("day_number")
  
  // Meals logged
  breakfastLogged Boolean     @default(false) @map("breakfast_logged")
  lunchLogged     Boolean     @default(false) @map("lunch_logged")
  dinnerLogged    Boolean     @default(false) @map("dinner_logged")
  snacksLogged    Int         @default(0) @map("snacks_logged")
  
  // Daily checklist state (keys match diet.dailyTracker items)
  checklist       Json?       // { "veggies_5": true, "protein_3": false, ... }
  completionPercent Float?    @map("completion_percent") // Auto-calculated 0.0-1.0
  
  // Symptoms tracking (for Medical diets) — 1-5 scale
  symptoms        Json?       // { "energy": 4, "bloating": 2, "digestion": 3, "mood": 5 }
  
  // Actual nutrients
  actualCalories  Int?        @map("actual_calories")
  actualProtein   Float?      @map("actual_protein")
  actualCarbs     Float?      @map("actual_carbs")
  actualFat       Float?      @map("actual_fat")
  
  // Targets
  targetCalories  Int?        @map("target_calories")
  targetProtein   Float?      @map("target_protein")
  targetCarbs     Float?      @map("target_carbs")
  targetFat       Float?      @map("target_fat")
  
  // Progress
  adherenceScore  Float?      @map("adherence_score")
  weight          Float?
  mood            String?     // 'great' | 'good' | 'okay' | 'bad'
  notes           String?
  
  // Day completion tracking
  completed       Boolean     @default(false) // Day marked as complete
  celebrationShown Boolean    @default(false) @map("celebration_shown") // Celebration already shown
  
  userDiet        UserDietProgram @relation(fields: [userDietId], references: [id], onDelete: Cascade)
  
  @@unique([userDietId, date])
  @@index([date])
  @@map("user_diet_daily_logs")
}

// Diet ratings and reviews
model DietProgramRating {
  id              String      @id @default(cuid())
  dietId          String      @map("diet_id")
  userId          String      @map("user_id")
  rating          Int         // 1-5
  review          String?     @db.Text
  
  // Results
  weightLost      Float?      @map("weight_lost")
  durationWeeks   Int?        @map("duration_weeks")
  wouldRecommend  Boolean?    @map("would_recommend")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  
  diet            DietProgram @relation(fields: [dietId], references: [id], onDelete: Cascade)
  user            User        @relation("UserDietRatings", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([dietId, userId])
  @@index([dietId])
  @@map("diet_program_ratings")
}

// ==================== REFERRAL SYSTEM ====================

model ReferralCode {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  code            String   @unique // "ALEX1234"
  usageCount      Int      @default(0) @map("usage_count")
  totalBonusDays  Int      @default(0) @map("total_bonus_days")
  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation("UserReferralCode", fields: [userId], references: [id], onDelete: Cascade)
  referrals       Referral[]

  @@index([code])
  @@map("referral_codes")
}

model Referral {
  id              String   @id @default(cuid())
  referralCodeId  String   @map("referral_code_id")
  referrerId      String   @map("referrer_id")
  referredId      String   @unique @map("referred_id")
  status          String   @default("completed")
  referrerBonus   Int      @default(7) @map("referrer_bonus")
  referredBonus   Int      @default(7) @map("referred_bonus")
  createdAt       DateTime @default(now()) @map("created_at")

  referralCode    ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  referrer        User         @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
  referred        User         @relation("ReferredUser", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
  @@map("referrals")
}

// ==========================================
// SUBSCRIPTION SYSTEM
// ==========================================

model SubscriptionPlan {
  id                   String              @id @default(cuid())
  name                 String              @unique // 'weekly', 'monthly', 'yearly', 'student'
  basePriceUsd         Float               @map("base_price_usd")
  durationDays         Int                 @map("duration_days")
  dailyLimit           Int                 @default(9999) @map("daily_limit") // Daily analysis limit for this plan
  features             Json                // ['feature1', 'feature2', ...]
  requiresVerification Boolean             @default(false) @map("requires_verification")
  displayOrder         Int                 @default(0) @map("display_order")
  isActive             Boolean             @default(true) @map("is_active")
  
  prices               SubscriptionPrice[]
  userSubscriptions    UserSubscription[]
  
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  @@map("subscription_plans")
}

model SubscriptionPrice {
  id                     String           @id @default(cuid())
  planId                 String           @map("plan_id")
  currencyCode           String           @map("currency_code") // 'USD', 'EUR', 'KZT', 'RUB', etc.
  price                  Float
  priceFormatted         String           @map("price_formatted") // '$9.99', '4 490 ₸'
  pricePerMonth          Float?           @map("price_per_month")
  pricePerMonthFormatted String?          @map("price_per_month_formatted")
  savingsPercent         Int?             @map("savings_percent")
  appleProductId         String?          @map("apple_product_id")
  googleProductId        String?          @map("google_product_id")
  
  plan                   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  createdAt              DateTime         @default(now()) @map("created_at")

  @@unique([planId, currencyCode])
  @@index([currencyCode])
  @@map("subscription_prices")
}

model UserSubscription {
  id                  String             @id @default(cuid())
  userId              String             @map("user_id")
  planId              String             @map("plan_id")
  currency            String
  pricePaid           Float              @map("price_paid")
  status              SubscriptionStatus @default(ACTIVE)
  startDate           DateTime           @default(now()) @map("start_date")
  endDate             DateTime           @map("end_date")
  cancelledAt         DateTime?          @map("cancelled_at")
  autoRenew           Boolean            @default(true) @map("auto_renew")
  appleTransactionId  String?            @map("apple_transaction_id")
  googlePurchaseToken String?            @map("google_purchase_token")
  studentVerified     Boolean            @default(false) @map("student_verified")
  studentEmail        String?            @map("student_email")
  
  plan                SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("user_subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
}

// ==================== PROGRAM SUGGESTIONS ====================

model ProgramSuggestion {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   // 'diet' | 'lifestyle'
  votes       Int      @default(1)
  voters      String[] // Array of userIds who voted
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  status      String   @default("pending") // pending, approved, rejected
  
  @@index([status, votes])
  @@index([type, status])
  @@map("program_suggestions")
}
