generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  password               String?
  appleUserId            String?                 @unique
  profile                Json?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  aiAssistant            AiAssistant[]
  analyses               Analysis[]
  labResults             LabResult[]
  magicLinks             MagicLink[]
  mealLogs               MealLog[]
  meals                  Meal[]
  media                  Media[]
  notificationPreference NotificationPreference?
  otps                   Otp[]
  pushTokens             PushToken[]
  refreshTokens          RefreshToken[]
  userProfile            UserProfile?
  userStats              UserStats?
  medications            MedicationSchedule[]
  medicationsNew         Medication[]            @relation("UserMedications")
  analysisCorrections    AnalysisCorrection[]

  // Marketplace
  specialist          Specialist?
  clientConsultations Consultation[] @relation("ClientConsultations")
  sentMessages        Message[]
  reviews             Review[]

  // Diet Programs
  userDietPrograms    UserDietProgram[]

  // Referral System
  referralCode        ReferralCode?  @relation("UserReferralCode")
  referralsMade       Referral[]     @relation("ReferrerUser")
  referredBy          Referral?      @relation("ReferredUser")

  @@map("users")
}

model UserProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  firstName             String?
  lastName              String?
  age                   Int?
  height                Float?
  weight                Float?
  gender                String?
  activityLevel         String?
  goal                  String?
  targetWeight          Float?
  dailyCalories         Int?
  avatarUrl             String?
  preferences           Json?
  healthProfile         Json?
  isOnboardingCompleted Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Analysis {
  id        String           @id @default(cuid())
  userId    String
  type      String
  status    String
  metadata  Json?
  error     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  results   AnalysisResult[]

  @@map("analyses")
}

model AnalysisResult {
  id         String   @id @default(cuid())
  analysisId String
  data       Json
  createdAt  DateTime @default(now())
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@map("analysis_results")
}

model Meal {
  id             String     @id @default(cuid())
  userId         String
  name           String
  type           String
  consumedAt     DateTime?
  healthScore    Float?     @map("health_score")
  healthGrade    String?    @map("health_grade")
  healthInsights Json?      @map("health_insights")
  imageUri       String?    @map("image_uri")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  items          MealItem[]
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("meals")
}

model MealItem {
  id       String  @id @default(cuid())
  mealId   String
  name     String
  calories Float
  protein  Float
  fat      Float
  carbs    Float
  weight   Float?
  fiber    Float?
  sugars   Float?
  satFat   Float?  @map("sat_fat")
  meal     Meal    @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@map("meal_items")
}

model MealLog {
  id        String          @id @default(cuid())
  userId    String
  mealType  MealLogMealType
  fdcId     String?
  label     String
  quantity  Float?
  unit      String?
  calories  Float?
  protein   Float?
  fat       Float?
  carbs     Float?
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([fdcId])
  @@map("meal_logs")
}

model Media {
  id              String   @id @default(cuid())
  userId          String
  filename        String
  mimetype        String
  size            Int
  data            Bytes?
  storageKey      String?
  storageBucket   String?
  storageProvider String?  @default("database")
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("media")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  jti       String?  @unique
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Otp {
  id        String   @id @default(cuid())
  userId    String
  code      String
  secret    String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otps")
}

model MagicLink {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@map("magic_links")
}

model AiAssistant {
  id               String   @id @default(cuid())
  userId           String
  type             String
  question         String
  answer           String
  context          Json?
  tokensUsed       Int?
  promptTokens     Int?
  completionTokens Int?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_assistant")
}

model PushToken {
  id         String    @id @default(cuid())
  userId     String?
  token      String    @unique
  deviceId   String?
  platform   String?
  appVersion String?
  enabled    Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_tokens")
}

model NotificationPreference {
  id               String    @id @default(cuid())
  userId           String    @unique
  dailyPushEnabled Boolean   @default(false)
  dailyPushHour    Int       @default(8)
  timezone         String    @default("UTC")
  lastPushSentAt   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Article {
  id             String    @id @default(cuid())
  slug           String
  title          String
  contentHtml    String?   @map("content_html")
  excerpt        String?   @map("excerpt")
  coverUrl       String?   @map("cover_url")
  coverAlt       String?   @map("cover_alt")
  sourceName     String?   @map("source_name")
  sourceUrl      String?   @map("source_url")
  readingMinutes Int?      @map("reading_minutes")
  tags           String[]
  isFeatured     Boolean   @default(false) @map("is_featured")
  isPublished    Boolean   @default(true) @map("is_published")
  viewCount      Int       @default(0) @map("view_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  publishedAt    DateTime? @map("published_at")
  authorId       String?   @map("author_id")
  bodyMarkdown   String    @map("body_markdown")
  heroImageUrl   String?   @map("hero_image_url")
  isActive       Boolean   @default(true) @map("is_active")
  locale         String    @default("ru")
  subtitle       String?   @map("subtitle")

  @@unique([slug, locale])
  @@index([locale, isActive])
  @@index([isActive, isFeatured])
  @@index([tags])
  @@map("articles")
}

model Food {
  id             String                   @id @default(uuid())
  fdcId          Int                      @unique @map("fdc_id")
  dataType       String                   @map("data_type")
  description    String
  brandOwner     String?                  @map("brand_owner")
  gtinUpc        String?                  @unique @map("gtin_upc")
  scientificName String?                  @map("scientific_name")
  publishedAt    DateTime?                @map("published_at")
  updatedAt      DateTime?                @map("updated_at")
  source         FoodSource               @default(USDA_LOCAL)
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAtRow   DateTime                 @updatedAt @map("updated_at_row")
  searchVector   Unsupported("tsvector")? @map("search_vector")
  embedding      FoodEmbedding?
  nutrients      FoodNutrient[]
  portions       FoodPortion[]
  label          LabelNutrients?

  @@index([fdcId])
  @@index([dataType])
  @@index([description])
  @@map("foods")
}

model FoodPortion {
  id          String  @id @default(uuid())
  foodId      String  @map("food_id")
  gramWeight  Float   @map("gram_weight")
  measureUnit String  @map("measure_unit")
  modifier    String?
  amount      Float?
  food        Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_portions")
}

model Nutrient {
  id       Int            @id
  number   String?
  name     String
  unitName String         @map("unit_name")
  rank     Int?
  foods    FoodNutrient[]

  @@map("nutrients")
}

model FoodNutrient {
  id         String   @id @default(uuid())
  foodId     String   @map("food_id")
  nutrientId Int      @map("nutrient_id")
  amount     Float
  food       Food     @relation(fields: [foodId], references: [id], onDelete: Cascade)
  nutrient   Nutrient @relation(fields: [nutrientId], references: [id])

  @@unique([foodId, nutrientId])
  @@index([foodId])
  @@index([nutrientId])
  @@map("food_nutrients")
}

model LabelNutrients {
  foodId        String @id @map("food_id")
  calories      Float?
  protein       Float?
  fat           Float?
  carbohydrates Float?
  fiber         Float?
  sugars        Float?
  sodium        Float?
  cholesterol   Float?
  potassium     Float?
  calcium       Float?
  iron          Float?
  food          Food   @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@map("label_nutrients")
}

model FoodEmbedding {
  foodId    String  @id @map("food_id")
  embedding Bytes
  doc       String
  ts        String?
  food      Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_embeddings")
}

enum MealLogMealType {
  BREAKFAST
  LUNCH
  DINNER
}

model UserStats {
  id                  String    @id @default(cuid())
  userId              String    @unique
  totalPhotosAnalyzed Int       @default(0) @map("total_photos_analyzed")
  todayPhotosAnalyzed Int       @default(0) @map("today_photos_analyzed")
  lastAnalysisDate    DateTime? @map("last_analysis_date")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}

model AnalysisCorrection {
  id              String    @id @default(cuid())
  userId          String
  analysisId      String?
  mealId          String?
  itemId          String?
  originalName    String
  correctedName   String?
  originalPortionG Float?   @map("original_portion_g")
  correctedPortionG Float?  @map("corrected_portion_g")
  originalCalories Float?   @map("original_calories")
  correctedCalories Float?  @map("corrected_calories")
  originalProtein Float?   @map("original_protein")
  correctedProtein Float?  @map("corrected_protein")
  originalCarbs   Float?   @map("original_carbs")
  correctedCarbs  Float?   @map("corrected_carbs")
  originalFat     Float?   @map("original_fat")
  correctedFat    Float?   @map("corrected_fat")
  correctionType  String   @map("correction_type")
  foodCategory    String?  @map("food_category")
  createdAt       DateTime @default(now()) @map("created_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([analysisId])
  @@index([mealId])
  @@index([correctionType])
  @@index([foodCategory])
  @@map("analysis_corrections")
}

// P3.1: Medication Schedule Model (legacy - kept for backward compatibility)
model MedicationSchedule {
  id              String    @id @default(cuid())
  userId          String
  name            String
  dosage          String? // e.g., "1 tablet", "500mg"
  frequency       String // e.g., "daily", "twice_daily", "weekly", "custom"
  times           String[] // Array of time strings in HH:mm format, e.g., ["08:00", "20:00"]
  daysOfWeek      Int[] // 0-6 (Sunday-Saturday), empty array means every day
  startDate       DateTime  @default(now()) @map("start_date")
  endDate         DateTime? @map("end_date")
  notes           String?
  isActive        Boolean   @default(true) @map("is_active")
  reminderEnabled Boolean   @default(true) @map("reminder_enabled")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("medication_schedules")
}

// P3.1: New Medication Model with MedicationDose support
model Medication {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation("UserMedications", fields: [userId], references: [id], onDelete: Cascade)
  name         String // Название лекарства: "Метформин", "Витамин D" и т.п.
  dosage       String? // Свободная строка: "500 mg", "1 таблетка", ...
  instructions String? // Доп. инструкции: "Перед едой", "После ужина" и т.д.
  startDate    DateTime  @default(now()) // Дата начала курса
  endDate      DateTime? // Дата окончания курса (nullable; если null — бессрочно)
  timezone     String    @default("UTC") // IANA timezone, например "Asia/Almaty"
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doses MedicationDose[]

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("medications")
}

model MedicationDose {
  id           String     @id @default(cuid())
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  // Время приёма в формате "HH:mm" (локальное время в timezone лекарства)
  timeOfDay String

  beforeMeal Boolean @default(false)
  afterMeal  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("medication_doses")
}

model LabResult {
  id             String      @id @default(cuid())
  userId         String
  rawText        String?     @map("raw_text")
  summary        String?
  recommendation String?
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics        LabMetric[]

  @@index([userId, createdAt])
  @@map("lab_results")
}

model LabMetric {
  id          String    @id @default(cuid())
  labResultId String    @map("lab_result_id")
  name        String
  value       Float
  unit        String
  isNormal    Boolean   @default(true) @map("is_normal")
  level       String // "low", "normal", "high"
  comment     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  labResult   LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@map("lab_metrics")
}

enum FoodSource {
  USDA_LOCAL
  USDA_API
}

// Локальная таблица топ-100 самых частых продуктов для быстрого поиска
model LocalFood {
  id          String   @id @default(cuid())
  name        String   // Название продукта (нормализованное)
  nameEn      String?  @map("name_en") // Английское название
  nameRu      String?  @map("name_ru") // Русское название
  nameKk      String?  @map("name_kk") // Казахское название
  
  // Питательные вещества на 100г
  calories    Float    @default(0)
  protein     Float    @default(0)
  carbs       Float    @default(0)
  fat         Float    @default(0)
  fiber       Float?   @default(0)
  sugars      Float?   @default(0)
  satFat      Float?   @default(0) @map("sat_fat")
  
  // Категория
  category    String?  // "vegetable", "fruit", "meat", "dairy", etc.
  
  // Порядок сортировки (чем меньше, тем популярнее)
  popularity  Int      @default(100)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([name])
  @@index([name])
  @@index([popularity])
  @@index([category])
  @@map("local_foods")
}

// ==================== MARKETPLACE ====================

model Specialist {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  type            String   // "dietitian" | "nutritionist"
  displayName     String   @map("display_name")
  bio             String?
  avatarUrl       String?  @map("avatar_url")
  credentials     String?
  languages       String[] @default(["en"])
  pricePerWeek    Float    @map("price_per_week")
  currency        String   @default("CHF")
  isVerified      Boolean  @default(false) @map("is_verified")
  isActive        Boolean  @default(true) @map("is_active")
  rating          Float    @default(0)
  reviewCount     Int      @default(0) @map("review_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations   Consultation[]
  reviews         Review[]

  @@index([type, isActive])
  @@index([isVerified, isActive])
  @@map("specialists")
}

model Consultation {
  id              String   @id @default(cuid())
  clientId        String   @map("client_id")
  specialistId    String   @map("specialist_id")
  status          String   @default("active") // "active" | "completed" | "cancelled"
  startsAt        DateTime @default(now()) @map("starts_at")
  endsAt          DateTime @map("ends_at")
  price           Float
  currency        String   @default("CHF")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  client          User       @relation("ClientConsultations", fields: [clientId], references: [id], onDelete: Cascade)
  specialist      Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  messages        Message[]
  review          Review?

  @@index([clientId, status])
  @@index([specialistId, status])
  @@map("consultations")
}

model Message {
  id              String   @id @default(cuid())
  consultationId  String   @map("consultation_id")
  senderId        String   @map("sender_id")
  type            String   @default("text") // "text" | "meal_share" | "lab_share"
  content         String
  metadata        Json?
  isRead          Boolean  @default(false) @map("is_read")
  createdAt       DateTime @default(now()) @map("created_at")

  consultation    Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([consultationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model Review {
  id              String   @id @default(cuid())
  consultationId  String   @unique @map("consultation_id")
  clientId        String   @map("client_id")
  specialistId    String   @map("specialist_id")
  rating          Int      // 1-5
  comment         String?
  createdAt       DateTime @default(now()) @map("created_at")

  consultation    Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  client          User         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  specialist      Specialist   @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@index([specialistId])
  @@index([clientId])
  @@map("reviews")
}

// ==================== DIET PROGRAMS ====================

model DietProgram {
  id              String   @id @default(cuid())
  slug            String   @unique
  name            String
  subtitle        String?
  description     String?
  imageUrl        String?  @map("image_url")
  category        String   // "hollywood" | "athletes" | "historical" | "modern"
  duration        Int      // дней
  dailyCalories   Int?     @map("daily_calories")
  difficulty      String?  // "easy" | "medium" | "hard"
  tags            String[]
  isActive        Boolean  @default(true) @map("is_active")
  isFeatured      Boolean  @default(false) @map("is_featured")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  days            DietProgramDay[]
  userPrograms    UserDietProgram[]

  @@index([category, isActive])
  @@index([isFeatured, isActive])
  @@map("diet_programs")
}

model DietProgramDay {
  id              String   @id @default(cuid())
  programId       String   @map("program_id")
  dayNumber       Int      @map("day_number")
  title           String?
  description     String?
  totalCalories   Int?     @map("total_calories")
  totalProtein    Float?   @map("total_protein")
  totalCarbs      Float?   @map("total_carbs")
  totalFat        Float?   @map("total_fat")

  program         DietProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  meals           DietProgramMeal[]

  @@unique([programId, dayNumber])
  @@index([programId])
  @@map("diet_program_days")
}

model DietProgramMeal {
  id              String   @id @default(cuid())
  dayId           String   @map("day_id")
  mealType        String   @map("meal_type") // "breakfast" | "lunch" | "dinner" | "snack"
  name            String
  description     String?
  calories        Int?
  protein         Float?
  carbs           Float?
  fat             Float?
  sortOrder       Int      @default(0) @map("sort_order")

  day             DietProgramDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@index([dayId])
  @@map("diet_program_meals")
}

model UserDietProgram {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  programId       String    @map("program_id")
  startedAt       DateTime  @default(now()) @map("started_at")
  currentDay      Int       @default(1) @map("current_day")
  status          String    @default("active") // "active" | "completed" | "paused" | "abandoned"
  completedAt     DateTime? @map("completed_at")

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  program         DietProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId, status])
  @@map("user_diet_programs")
}

// ==================== REFERRAL SYSTEM ====================

model ReferralCode {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  code            String   @unique // "ALEX1234"
  usageCount      Int      @default(0) @map("usage_count")
  totalBonusDays  Int      @default(0) @map("total_bonus_days")
  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation("UserReferralCode", fields: [userId], references: [id], onDelete: Cascade)
  referrals       Referral[]

  @@index([code])
  @@map("referral_codes")
}

model Referral {
  id              String   @id @default(cuid())
  referralCodeId  String   @map("referral_code_id")
  referrerId      String   @map("referrer_id")
  referredId      String   @unique @map("referred_id")
  status          String   @default("completed")
  referrerBonus   Int      @default(7) @map("referrer_bonus")
  referredBonus   Int      @default(7) @map("referred_bonus")
  createdAt       DateTime @default(now()) @map("created_at")

  referralCode    ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  referrer        User         @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
  referred        User         @relation("ReferredUser", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
  @@map("referrals")
}
