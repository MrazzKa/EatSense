generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  password               String
  profile                Json?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  aiAssistant            AiAssistant[]
  analyses               Analysis[]
  labResults             LabResult[]
  magicLinks             MagicLink[]
  mealLogs               MealLog[]
  meals                  Meal[]
  media                  Media[]
  notificationPreference NotificationPreference?
  otps                   Otp[]
  pushTokens             PushToken[]
  refreshTokens          RefreshToken[]
  userProfile            UserProfile?
  userStats              UserStats?
  medications            MedicationSchedule[]
  medicationsNew         Medication[]            @relation("UserMedications")

  @@map("users")
}

model UserProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  firstName             String?
  lastName              String?
  age                   Int?
  height                Float?
  weight                Float?
  gender                String?
  activityLevel         String?
  goal                  String?
  targetWeight          Float?
  dailyCalories         Int?
  preferences           Json?
  healthProfile         Json?
  isOnboardingCompleted Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Analysis {
  id        String           @id @default(cuid())
  userId    String
  type      String
  status    String
  metadata  Json?
  error     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  results   AnalysisResult[]

  @@map("analyses")
}

model AnalysisResult {
  id         String   @id @default(cuid())
  analysisId String
  data       Json
  createdAt  DateTime @default(now())
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@map("analysis_results")
}

model Meal {
  id             String     @id @default(cuid())
  userId         String
  name           String
  type           String
  consumedAt     DateTime?
  healthScore    Float?     @map("health_score")
  healthGrade    String?    @map("health_grade")
  healthInsights Json?      @map("health_insights")
  imageUri       String?    @map("image_uri")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  items          MealItem[]
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("meals")
}

model MealItem {
  id       String @id @default(cuid())
  mealId   String
  name     String
  calories Float
  protein  Float
  fat      Float
  carbs    Float
  weight   Float?
  meal     Meal   @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@map("meal_items")
}

model MealLog {
  id        String          @id @default(cuid())
  userId    String
  mealType  MealLogMealType
  fdcId     String?
  label     String
  quantity  Float?
  unit      String?
  calories  Float?
  protein   Float?
  fat       Float?
  carbs     Float?
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([fdcId])
  @@map("meal_logs")
}

model Media {
  id              String   @id @default(cuid())
  userId          String
  filename        String
  mimetype        String
  size            Int
  data            Bytes?
  storageKey      String?
  storageBucket   String?
  storageProvider String?  @default("database")
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("media")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  jti       String?
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Otp {
  id        String   @id @default(cuid())
  userId    String
  code      String
  secret    String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otps")
}

model MagicLink {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@map("magic_links")
}

model AiAssistant {
  id               String   @id @default(cuid())
  userId           String
  type             String
  question         String
  answer           String
  context          Json?
  tokensUsed       Int?
  promptTokens     Int?
  completionTokens Int?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_assistant")
}

model PushToken {
  id         String    @id @default(cuid())
  userId     String?
  token      String    @unique
  deviceId   String?
  platform   String?
  appVersion String?
  enabled    Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_tokens")
}

model NotificationPreference {
  id               String    @id @default(cuid())
  userId           String    @unique
  dailyPushEnabled Boolean   @default(false)
  dailyPushHour    Int       @default(8)
  timezone         String    @default("UTC")
  lastPushSentAt   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Article {
  id             String    @id @default(cuid())
  slug           String
  title          String
  contentHtml    String?   @map("content_html")
  excerpt        String?   @map("excerpt")
  coverUrl       String?   @map("cover_url")
  coverAlt       String?   @map("cover_alt")
  sourceName     String?   @map("source_name")
  sourceUrl      String?   @map("source_url")
  readingMinutes Int?      @map("reading_minutes")
  tags           String[]
  isFeatured     Boolean   @default(false) @map("is_featured")
  isPublished    Boolean   @default(true) @map("is_published")
  viewCount      Int       @default(0) @map("view_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  publishedAt    DateTime? @map("published_at")
  authorId       String?   @map("author_id")
  bodyMarkdown   String    @map("body_markdown")
  heroImageUrl   String?   @map("hero_image_url")
  isActive       Boolean   @default(true) @map("is_active")
  locale         String    @default("ru")
  subtitle       String?   @map("subtitle")

  @@unique([slug, locale])
  @@index([locale, isActive])
  @@index([isActive, isFeatured])
  @@index([tags])
  @@map("articles")
}

model Food {
  id             String                   @id @default(uuid())
  fdcId          Int                      @unique @map("fdc_id")
  dataType       String                   @map("data_type")
  description    String
  brandOwner     String?                  @map("brand_owner")
  gtinUpc        String?                  @unique @map("gtin_upc")
  scientificName String?                  @map("scientific_name")
  publishedAt    DateTime?                @map("published_at")
  updatedAt      DateTime?                @map("updated_at")
  source         FoodSource               @default(USDA_LOCAL)
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAtRow   DateTime                 @updatedAt @map("updated_at_row")
  searchVector   Unsupported("tsvector")? @map("search_vector")
  embedding      FoodEmbedding?
  nutrients      FoodNutrient[]
  portions       FoodPortion[]
  label          LabelNutrients?

  @@index([fdcId])
  @@index([dataType])
  @@index([description])
  @@map("foods")
}

model FoodPortion {
  id          String  @id @default(uuid())
  foodId      String  @map("food_id")
  gramWeight  Float   @map("gram_weight")
  measureUnit String  @map("measure_unit")
  modifier    String?
  amount      Float?
  food        Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_portions")
}

model Nutrient {
  id       Int            @id
  number   String?
  name     String
  unitName String         @map("unit_name")
  rank     Int?
  foods    FoodNutrient[]

  @@map("nutrients")
}

model FoodNutrient {
  id         String   @id @default(uuid())
  foodId     String   @map("food_id")
  nutrientId Int      @map("nutrient_id")
  amount     Float
  food       Food     @relation(fields: [foodId], references: [id], onDelete: Cascade)
  nutrient   Nutrient @relation(fields: [nutrientId], references: [id])

  @@unique([foodId, nutrientId])
  @@index([foodId])
  @@index([nutrientId])
  @@map("food_nutrients")
}

model LabelNutrients {
  foodId        String @id @map("food_id")
  calories      Float?
  protein       Float?
  fat           Float?
  carbohydrates Float?
  fiber         Float?
  sugars        Float?
  sodium        Float?
  cholesterol   Float?
  potassium     Float?
  calcium       Float?
  iron          Float?
  food          Food   @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@map("label_nutrients")
}

model FoodEmbedding {
  foodId    String  @id @map("food_id")
  embedding Bytes
  doc       String
  ts        String?
  food      Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_embeddings")
}

enum MealLogMealType {
  BREAKFAST
  LUNCH
  DINNER
}

model UserStats {
  id                  String    @id @default(cuid())
  userId              String    @unique
  totalPhotosAnalyzed Int       @default(0) @map("total_photos_analyzed")
  todayPhotosAnalyzed Int       @default(0) @map("today_photos_analyzed")
  lastAnalysisDate    DateTime? @map("last_analysis_date")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}

// P3.1: Medication Schedule Model (legacy - kept for backward compatibility)
model MedicationSchedule {
  id              String    @id @default(cuid())
  userId          String
  name            String
  dosage          String? // e.g., "1 tablet", "500mg"
  frequency       String // e.g., "daily", "twice_daily", "weekly", "custom"
  times           String[] // Array of time strings in HH:mm format, e.g., ["08:00", "20:00"]
  daysOfWeek      Int[] // 0-6 (Sunday-Saturday), empty array means every day
  startDate       DateTime  @default(now()) @map("start_date")
  endDate         DateTime? @map("end_date")
  notes           String?
  isActive        Boolean   @default(true) @map("is_active")
  reminderEnabled Boolean   @default(true) @map("reminder_enabled")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("medication_schedules")
}

// P3.1: New Medication Model with MedicationDose support
model Medication {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation("UserMedications", fields: [userId], references: [id], onDelete: Cascade)
  name         String // Название лекарства: "Метформин", "Витамин D" и т.п.
  dosage       String? // Свободная строка: "500 mg", "1 таблетка", ...
  instructions String? // Доп. инструкции: "Перед едой", "После ужина" и т.д.
  startDate    DateTime  @default(now()) // Дата начала курса
  endDate      DateTime? // Дата окончания курса (nullable; если null — бессрочно)
  timezone     String    @default("UTC") // IANA timezone, например "Asia/Almaty"
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doses MedicationDose[]

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@map("medications")
}

model MedicationDose {
  id           String     @id @default(cuid())
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  // Время приёма в формате "HH:mm" (локальное время в timezone лекарства)
  timeOfDay String

  beforeMeal Boolean @default(false)
  afterMeal  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("medication_doses")
}

model LabResult {
  id             String      @id @default(cuid())
  userId         String
  rawText        String?     @map("raw_text")
  summary        String?
  recommendation String?
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics        LabMetric[]

  @@index([userId, createdAt])
  @@map("lab_results")
}

model LabMetric {
  id          String    @id @default(cuid())
  labResultId String    @map("lab_result_id")
  name        String
  value       Float
  unit        String
  isNormal    Boolean   @default(true) @map("is_normal")
  level       String // "low", "normal", "high"
  comment     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  labResult   LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@map("lab_metrics")
}

enum FoodSource {
  USDA_LOCAL
  USDA_API
}
